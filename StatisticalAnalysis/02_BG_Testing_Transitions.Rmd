---
title: "BG Testing Transitions"
output: html_notebook
---

```{r}
install.packages("tidyverse")
install.packages("readxl")
install.packages("ggplot2")
remove.packages("rlang")
install.packages("rlang")
install.packages("ggstatsplot")
```

```{r}
library(tidyverse)
library(readxl)
library(ggplot2)
library(ggstatsplot)
library(patchwork)
library(readxl)
library(dplyr)
library(purrr)
library(stringr)

# Experiment numbers
exp_numbers <- sprintf("%03d", 28:30)
exp_labels <- c("028" = "#1", "029" = "#2", "030" = "#3")
sheet_names <- c("reward_over_time", "activation_over_time")

# Base folder path
base_path <- "../Data/Experiments/02_Grasping"

# Function to safely load one experiment
load_experiment_data <- function(exp_num, sheets) {
  exp_path <- file.path(base_path, exp_num)
  file <- list.files(exp_path, pattern = "MotorLoop\\.xlsx$", full.names = TRUE)[1]
  
  if (length(file) == 0) {
    warning(paste("No MotorLoop.xlsx found for experiment", exp_num))
    return(NULL)
  }
  
  # Dynamically read all sheets
  exp_data <- map(sheets, ~ read_excel(file, sheet = .x) %>% mutate(iteration = time / 100))
  names(exp_data) <- sheets
  exp_data
}

# Load all experiments into a named list
experiments <- set_names(map(exp_numbers, ~ load_experiment_data(.x, sheet_names)), exp_numbers)

# Add goal to each experiment
experiments <- map(experiments, function(exp) {
  df <- exp$reward_over_time
  goal_cols <- names(df)[
    sapply(df, function(x) any(x == 1, na.rm = TRUE)) & !(names(df) %in% c("time", "iteration"))
  ]
  
  exp$goals <- goal_cols
  exp
})

# --- Helper function: extract data from one sheet ---
extract_sheet_data <- function(experiments, sheet_name) {
  map_dfr(names(experiments), function(exp_num) {
    exp <- experiments[[exp_num]]
    goals <- exp$goals
    df <- exp[[sheet_name]]
    
    if (is.null(df) || length(goals) == 0) return(NULL)
    
    df %>%
      select(iteration, all_of(goals)) %>%
      pivot_longer(cols = all_of(goals), names_to = "goal", values_to = "value") %>%
      mutate(
        experiment = exp_num,
        sheet = sheet_name
      )
  })
}

# --- Combine all sheets into one tidy dataframe ---
all_data <- map_dfr(sheet_names, extract_sheet_data, experiments = experiments)
all_data <- all_data %>%
  mutate(
    sheet_clean = sheet %>%
      str_remove("_over_time$") %>%        # remove "_over_time"
      str_replace_all("_", " ") %>%        # replace underscores with spaces
      str_to_title(), 
    sheet_clean = factor(sheet_clean,      # convert to factor
                         levels = sheet_names %>% 
                           str_remove("_over_time$") %>%
                           str_replace_all("_", " ") %>%
                           str_to_title())
  )
```


```{r}
transitions <- c(10, 20)

ggplot(all_data, aes(x = iteration, y = value, group = interaction(experiment, goal), color = goal)) +
  geom_line(alpha = 0.6, size = 1) +
  geom_vline(xintercept = transitions, color = "black", linetype = "dashed", size = 0.5) +
  facet_grid(experiment ~ sheet_clean, # rows = experiments, columns = sheets
             scales = "fixed",
             labeller = labeller(experiment = exp_labels)) +  
  labs(
    x = "Iteration",
    y = "Value",
    color = "Goal"
  ) +
  scale_x_continuous(
    breaks = seq(0, max(all_data$iteration), by = 10)  # show every 10 iterations
  ) +
  scale_y_continuous(
    breaks = scales::pretty_breaks(n = 3)   # 3 ticks on y-axis
  )+
  theme_minimal(base_size = 14) +
  theme(
    strip.text.y.right = element_text(angle = 0),
    axis.text.x = element_text( hjust = 1),
    legend.position = "right"
  )

```

```{r}
# Function to compute activation delays after transitions
compute_activation_delays <- function(exp, transitions) {
  df <- exp$activation_over_time
  goals <- exp$goals
  
  # Loop over transitions
  map_dfr(transitions, function(t) {
    after_t <- df %>% filter(iteration > t)
    
    # Only consider goals that were inactive at the transition
    inactive_at_transition <- goals[sapply(goals, function(g) df[[g]][df$iteration == t] == 0)]
    if (length(inactive_at_transition) == 0) return(NULL)
    
    # For each goal, find its first 0->1 activation
    first_activations <- map_dfr(inactive_at_transition, function(goal) {
      # Compute 0->1 change
      prev <- dplyr::lag(after_t[[goal]], default = 0)
      change <- after_t[[goal]] - prev
      
      first_iter <- after_t$iteration[which(change == 1)]
      if (length(first_iter) == 0) first_iter <- NA_real_
      first_iter <- min(first_iter, na.rm = TRUE)
      if (is.infinite(first_iter)) first_iter <- NA_real_
      
      tibble(goal = goal, first_iter = first_iter)
    })
  
    # Pick the first activated goal
    first_activations <- first_activations %>%
      filter(!is.na(first_iter)) %>%
      arrange(first_iter)
    
    if (nrow(first_activations) == 0) return(NULL)
    
    next_goal <- first_activations$goal[1]
    next_iter <- first_activations$first_iter[1]
  
    tibble(
      transition_iter = t,
      next_goal = next_goal,
      first_activation_iter = next_iter,
      delay = next_iter - t
    )
  })
}

# Apply across all experiments
activation_delays <- map_dfr(names(experiments), function(exp_num) {
  exp <- experiments[[exp_num]]
  compute_activation_delays(exp, transitions) %>%
    mutate(experiment = exp_num)
})

label <- ""
mean_delay_value <- mean(activation_delays$delay, na.rm = TRUE)
mean_delay_df <- tibble(
  x = label,
  y = mean_delay_value
)

ggplot(activation_delays, aes(y = label, x = delay)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black", size = 0.8) +
  geom_boxplot(width = 0.4, alpha = 0.6, outlier.shape = NA) +
  geom_jitter(aes(color = as.factor(next_goal)), height = 0.1, width = 0, size = 2, alpha = 0.8) +
  geom_point(data = mean_delay_df, aes(y = label, x = mean_delay),
             color = "darkred", size = 3, shape = 16) +
  geom_label(data = mean_delay_df,
             aes(y = label, x = mean_delay, label = paste0("mean = ", round(mean_delay, 1))),
             fill = "white", color = "black", label.r = unit(0.15, "lines"),
             size = 3, label.padding = unit(0.05, "lines"), hjust = 0, nudge_y = 0.15) +
  labs(
    y = "Correct Activation",
    x = "Iterations after Grasp Type Change",
    color = "New Goal"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "non")
```






 

